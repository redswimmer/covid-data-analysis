---
title: "COVID-19 Data Analysis"
author: "Andrew Savala"
date: "2025-04-01"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#library(dplyr)
library(ggplot2)
library(lubridate)
library(corrplot)
library(tidyverse)
```

## Overview

In this project I will be analyzing COVID-19 data from the the Center for Systems Science and Engineering (CSSE) at Johns Hopkins University.  The dataset contains daily time series summary tables, including confirmed, deaths and recovered.

On March 10, 2023, the Johns Hopkins Coronavirus Resource Center ceased its collecting and reporting of global COVID-19 data.

## Step 1: Import COVID-19 Data

```{r import}
# Read time series data from Johns Hopkins University GitHub repository
# Raw base URL
url_base <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/"
file_names <- c("time_series_covid19_confirmed_global.csv", 
                "time_series_covid19_deaths_global.csv", 
                "time_series_covid19_confirmed_US.csv",
                "time_series_covid19_deaths_US.csv")
urls <- str_c(url_base, file_names)

global_cases <- read_csv(urls[1], show_col_types = FALSE)
global_deaths <- read_csv(urls[2], show_col_types = FALSE)
us_cases <- read_csv(urls[3], show_col_types = FALSE)
us_deaths <- read_csv(urls[4], show_col_types = FALSE)
```

## Step 2: Tidy and Transform Data

### Examine Our Data

Here's our raw data:
```{r display}
# Display our raw COVID-19 data
head(global_cases)
head(global_deaths)
head(us_cases)
head(us_deaths)
```
### Global Data

Lets start by transforming our global data.
```{r transform global-data}
# Convert global cases wide to long format and drop lat and long
global_cases_long <- global_cases %>%
  pivot_longer(cols = -c(`Province/State`, `Country/Region`, Lat, Long), 
               names_to = "Date", values_to = "Cases") %>%
  mutate(Date = mdy(Date)) %>%
  select(-Lat, -Long)

global_deaths_long <- global_deaths %>%
  pivot_longer(cols = -c(`Province/State`, `Country/Region`, Lat, Long), 
               names_to = "Date", values_to = "Deaths") %>%
  mutate(Date = mdy(Date)) %>%
  select(-Lat, -Long)

head(global_cases_long)
head(global_deaths_long)
```
We can combine our global data.
```{r combine global-data}
# Combine global cases and deaths data
global_data <- global_cases_long %>%
  full_join(global_deaths_long, by = c("Province/State", "Country/Region", "Date")) %>%
  rename(Province_State = `Province/State`, Country_Region = `Country/Region`)

summary(global_data)
```
Lets filter our global data to only include countries with cases greater than 0.  This will help us with our analysis.

```{r filter global-data}
# Filter global data where the cases are positive
global_data <- global_data %>% filter(Cases > 0)
summary(global_data)
```
Lastly, let add the population data to our global data from John Hopkins University GitHub.

```{r add population}
# Create a Combined_Key column for global data
global_data <- global_data %>%
  unite("Combined_Key", c(Province_State, Country_Region), sep = ", ", na.rm = TRUE, remove = FALSE)

# Download population data from John Hopkins University
uid_lookup_url <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv"
uid <- read_csv(uid_lookup_url, show_col_types = FALSE) %>%
  select(Province_State, Country_Region, Population)

# Join population data to global data by Country_Region and Province_State
global_data <- global_data %>%
  left_join(uid, by = c("Province_State", "Country_Region")) %>%
  select(Province_State, Country_Region, Date, Cases, Deaths, Population, Combined_Key)

# Lets filter to only show populations > 0
global_data <- global_data %>% filter(Population > 0)

summary(global_data)
```

### US Data

Lets continue with looking at our US data.

```{r transform us-data}
# Convert US cases wide to long format and drop columns we don't care about
us_cases_long <- us_cases %>%
  pivot_longer(cols = -(UID:Combined_Key), 
               names_to = "Date", values_to = "Cases") %>%
  select(Admin2:Cases) %>%
  mutate(Date = mdy(Date)) %>%
  select(-c(Lat, Long_))

# Do the same with the US Deaths data
us_deaths_long <- us_deaths %>%
  pivot_longer(cols = -(UID:Population),
               names_to = "Date", values_to = "Deaths") %>%
  select(Admin2:Deaths) %>%
  mutate(Date = mdy(Date)) %>%
  select(-c(Lat, Long_))

head(us_cases_long)
head(us_deaths_long)
```

We can combine our US data.

```{r combine us-data}
# Combine us cases and deaths data
us_data <- us_cases_long %>%
  full_join(us_deaths_long)
```
Lets filter our US data to only include states with cases greater than 0.  This will help us with our analysis.
```{r filter us-data}
# Filter US data where the cases and population are positive
us_data <- us_data %>% filter(Cases > 0) %>% filter(Population > 0)
summary(us_data)
```
## Visualizations and Analysis

### US Visualizations

Lets start with some visualizations of the US data.  We will create a few plots to show the trends in cases and deaths over time.

```{r us-visualizations}
# US totals by state
us_by_state <- us_data %>%
  group_by(Province_State, Country_Region, Date) %>%
  summarise(Cases = sum(Cases), Deaths = sum(Deaths), Population = sum(Population)) %>%
  mutate(Deaths_Per_Mil = Deaths * 1000000 / Population,
         Cases_Per_Mil = Cases * 1000000 / Population) %>%
  select(Province_State, Country_Region, Date, Cases, Deaths, Population, Deaths_Per_Mil, Cases_Per_Mil) %>%
  ungroup()

# US totals
us_totals <- us_data %>%
  group_by(Country_Region, Date) %>%
  summarise(Cases = sum(Cases), Deaths = sum(Deaths), Population = sum(Population)) %>%
  mutate(Deaths_Per_Mil = Deaths * 1000000 / Population,
         Cases_Per_Mil = Cases * 1000000 / Population) %>%
  select(Country_Region, Date, Cases, Deaths, Population, Deaths_Per_Mil, Cases_Per_Mil) %>%
  ungroup()

# Plot US totals for cases and deaths over time and filter to only show cases > 0.  Lets also scale Y so we can compare the trends.
us_totals %>%
  filter(Cases > 0) %>%
  ggplot(aes(x = Date, y = Cases)) +
  geom_line(aes(y = Cases, color = "Cases")) +
  geom_point(aes(y = Cases, color = "Cases")) +
  geom_line(aes(y = Deaths, color = "Deaths")) +
  geom_point(aes(y = Deaths, color = "Deaths")) +
  scale_y_log10() +
  labs(title = "US COVID-19 Cases and Deaths Over Time",
       x = "Date",
       y = "Count") +
  scale_color_manual(values = c("Cases" = "blue", "Deaths" = "red")) +
  theme_minimal()
# 
# Now lets do the same thing, but just for the state of California
us_by_state %>%
  filter(Cases > 0) %>%
  filter(Province_State == "California") %>%
  ggplot(aes(x = Date, y = Cases)) +
  geom_line(aes(y = Cases, color = "Cases")) +
  geom_point(aes(y = Cases, color = "Cases")) +
  geom_line(aes(y = Deaths, color = "Deaths")) +
  geom_point(aes(y = Deaths, color = "Deaths")) +
  scale_y_log10() +
  labs(title = "California COVID-19 Cases and Deaths Over Time",
       x = "Date",
       y = "Count") +
  scale_color_manual(values = c("Cases" = "blue", "Deaths" = "red")) +
  theme_minimal()

```
### US Analysis

```{r us-analysis}
us_totals <- us_totals %>%
  mutate(New_Cases = Cases - lag(Cases, default = 0),
         New_Deaths = Deaths - lag(Deaths, default = 0))

us_totals_weekly <- us_totals %>%
  mutate(Week = floor_date(Date, "week")) %>%
  group_by(Week) %>%
  summarise(
    Weekly_Cases = sum(New_Cases, na.rm = TRUE),
    Weekly_Deaths = sum(New_Deaths, na.rm = TRUE)
  )

us_totals_weekly %>%
  filter(Weekly_Cases > 0, Weekly_Deaths > 0) %>%
  ggplot(aes(x = Week, y = Weekly_Cases)) +
  geom_line(aes(color = "Weekly Cases")) +
  geom_point(aes(color = "Weekly Cases")) +
  geom_line(aes(y = Weekly_Deaths, color = "Weekly Deaths")) +
  geom_point(aes(y = Weekly_Deaths, color = "Weekly Deaths")) +
  scale_y_log10() +
  labs(
    title = "US COVID-19 New Cases and Deaths Over Time (Weekly Totals)",
    x = "Week",
    y = "Count"
  ) +
  scale_color_manual(values = c("Weekly Cases" = "blue", "Weekly Deaths" = "red")) +
  theme_minimal()
```

```{r state-analysis}
us_by_state <- us_by_state %>%
  mutate(New_Cases = Cases - lag(Cases, default = 0),
         New_Deaths = Deaths - lag(Deaths, default = 0))

ca_totals_weekly <- us_by_state %>%
  filter(Province_State == "California") %>%
  mutate(Week = floor_date(Date, "week")) %>%
  group_by(Week) %>%
  summarise(
    Weekly_Cases = sum(New_Cases, na.rm = TRUE),
    Weekly_Deaths = sum(New_Deaths, na.rm = TRUE)
  )

ca_totals_weekly %>%
  filter(Weekly_Cases > 0, Weekly_Deaths > 0) %>%
  ggplot(aes(x = Week, y = Weekly_Cases)) +
  geom_line(aes(color = "Weekly Cases")) +
  geom_point(aes(color = "Weekly Cases")) +
  geom_line(aes(y = Weekly_Deaths, color = "Weekly Deaths")) +
  geom_point(aes(y = Weekly_Deaths, color = "Weekly Deaths")) +
  scale_y_log10() +
  labs(
    title = "California COVID-19 New Cases and Deaths Over Time (Weekly Totals)",
    x = "Week",
    y = "Count"
  ) +
  scale_color_manual(values = c("Weekly Cases" = "blue", "Weekly Deaths" = "red")) +
  theme_minimal()
```
We're going to focus our analysis on the states with the most deaths and cases per thousand.

```{r us-per-thousand}
# Calculate cases and deaths per thousand grouped by state
us_state_totals <- us_by_state %>%
  group_by(Province_State) %>%
  summarise(Cases = max(Cases), Deaths = max(Deaths), 
            Population = max(Population),
            Cases_Per_Thousand = 1000 * Cases / Population,
            Deaths_Per_Thousand = 1000 * Deaths / Population) %>%
  filter(Cases > 0, Population > 0)

# Find top 5 states with most Deaths_Per_Thousand
us_state_totals %>%
  arrange(desc(Deaths_Per_Thousand)) %>%
  slice(1:5) %>%
  ggplot(aes(x = reorder(Province_State, Deaths_Per_Thousand), y = Deaths_Per_Thousand)) +
  geom_bar(stat = "identity", fill = "red") +
  coord_flip() +
  labs(title = "Top 5 States with Most Deaths Per Thousand",
       x = "State",
       y = "Deaths Per Thousand") +
  theme_minimal()

# Find top 5 states with most Cases_Per_Thousand
us_state_totals %>%
  arrange(desc(Cases_Per_Thousand)) %>%
  slice(1:5) %>%
  ggplot(aes(x = reorder(Province_State, Cases_Per_Thousand), y = Cases_Per_Thousand)) +
  geom_bar(stat = "identity", fill = "blue") +
  coord_flip() +
  labs(title = "Top 5 States with Most Cases Per Thousand",
       x = "State",
       y = "Cases Per Thousand") +
  theme_minimal()
  
```

## Session Info

Record our session info for reproducibility.
```{r session-info}
sessionInfo()
```
